#!/bin/bash

#Usage: ./hxDelUser <user>
#Ex: ./hxDelUser testUser

userName="$1"

uniqueId=hovz-$RANDOM
mkdir -p /tmp/$uniqueId/

vzlist -a -o ctid,description > /tmp/$uniqueId/all

tail -n+2 /tmp/$uniqueId/all > /tmp/$uniqueId/all_noHeader

#TODO: Verify these fields.
for i in $( cat /tmp/$uniqueId/all_noHeader ); do
	if [[ $(echo "$i" | cut -f2- -d\ ) == "$userName" ]]
	then
		echo "$i" | cut -f1 -d\ >> /tmp/$uniqueId/ownedCTIDs
	fi
done

for j in $( cat /tmp/$uniqueId/ownedCTIDs); do
	hxDelVM "$j" "$userName"
done

rm /tmp/$uniqueId/all
rm /tmp/$uniqueId/hostnames
rmdir /tmp/$uniqueId/

userdel -r "$userName"